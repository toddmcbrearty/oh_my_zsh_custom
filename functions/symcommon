#!/bin/zsh zsh
function symcommon() {
   LOCAL_ONLY=false

  if [[ "$IAM" == "$LOCAL_MACHINE_NAME" ]]; then
    LOCAL_ONLY=true
  fi

  if [[ "$LOCAL_ONLY" != true ]]; then
    echo "You can not run this command in this environment."
    return
  fi

    if [[ ! -f artisan ]]; then
        echo "I can't find artisan. Are you sure you want to run this here?"
        return
    fi

    filepath=./.ggc-path
    vendorPath=./vendor/giftogram/gg-common

    if [[ "$1" == "help" ]]; then
        echo ""
        echo "Commands:"
        echo "  help         Show function usage."
        echo "  status       Check if ./vendor/giftogram/gg-common is a symlink to a directory."
        echo "  restore      Reinstall the package giftogram/gg-common using composer."
        echo "  [default]    Sync the gg-common directory by creating a symlink to the path specified."
        echo ""
        echo "Description:"
        echo "  The symcommon script performs operations related to the gg-common package."
        echo "  - It checks for the presence of the artisan file in the current directory."
        echo "  - If no command is provided, it prompts for the path to gg-common and sets up a symlink."
        echo ""
        echo "Examples:"
        echo "  symcommon help"
        echo "  symcommon status"
        echo "  symcommon restore"
        echo "  symcommon"
        return
    fi

    if [[ "$1" == "status" ]]; then
        if [[ -L "$vendorPath" && -d "$vendorPath" ]]; then
            echo "$vendorPath is a symlink to a directory"
            return
        fi

        echo "$vendorPath is not a symlink"
        return;
    fi

    if [[ "$1" == "restore" ]]; then
        composer reinstall giftogram/gg-common
        return
    fi

    if [[ "$1" == "--relink" ]]; then
        rm -rf "$filepath"
    fi

    if [[ ! -f "$filepath" ]]; then
        echo "Enter the path to gg-common: "
        read -r commonPath

        printf "--this file is automatically generated, do not edit.\n%s" "$commonPath" > "$filepath"
    fi

    commonPath=$(sed -n '2p' "$filepath")

    rm -rf ./vendor/giftogram/gg-common
    ln -s "$commonPath" ./vendor/giftogram/gg-common

    echo "Common has been synced: $commonPath => ./vendor/giftogram/gg-common"
}

